
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE) 
library(dplyr)
library(janitor)
library(tidyverse)
library(DESeq2)
library(EnhancedVolcano)
library(pheatmap)
library(knitr)
library(fgsea)
library(msigdbr)
```

```{r}
# this function essentially adds cleaned names for each column, and adds a column with gene counts with the sample identifier as the name
process_file <- function(filepath, sample_name) {
  df <- read.csv(filepath, header = FALSE, sep = "\t")
  df$gene_id <- df$V1
  df$gene_name <- df$V2
  df[[sample_name]] <- df$V3
  df <- df[, c("gene_id", "gene_name", sample_name)]
  return(df)
}

```


```{r}
# loading in files
# TODO: change these file paths to wherever you stored the data
MC1_1 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC1-1.csv", "MC1-1")
MC1_2 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC1-2.csv", "MC1-2")
MC1_3 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC1-3.csv", "MC1-3")
MC1_4 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC1-4.csv", "MC1-4")

MC2_1 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC2-1.csv", "MC2-1")
MC2_2 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC2-2.csv", "MC2-2")
MC2_3 <- process_file("/Users/erikali/Desktop/MC1_MC2/MC2-3.csv", "MC2-3")


# merging all the files to make a counts dataframe
all_files <- list(MC1_1, MC1_2, MC1_3, MC1_4, MC2_1, MC2_2, MC2_3)
counts_df <- Reduce(function(x, y) merge(x, y, by = c("gene_id", "gene_name"), all = TRUE), all_files)
counts_df <- counts_df[-c(1,2,3,4,5),]
rownames(counts_df) <- NULL
```

```{r}
# load in metadata, which contains the group information of each sample (ie. MC1-1 is part of MC1)
# I did this manually in excel, with a column of sample names and another column with what group they correspond to, and saved as a csv file called metadata.csv 
# TODO: change file path to wherever you stored the data
col_data <- read.csv("/Users/erikali/Desktop/jakowec-petzinger-lab/MC1vsMC2/metadata.csv")
```

```{r}
# reformat count_df to run DESeq2 (same # cols as # rows in col_data)
count_mat <- counts_df %>% 
  column_to_rownames(var = "gene_id") %>%
  dplyr::select(-gene_name)
```

```{r, include=FALSE}
# differential expression
dds <- DESeqDataSetFromMatrix(countData = round(count_mat),
                              colData = col_data,
                              design = ~ group)
DEs <- DESeq(dds)

res <- results(DEs,
               pAdjustMethod = "BH",  
               name = "group_MC2_vs_MC1",  
               alpha = 0.05,          
               independentFiltering = TRUE)
res_sig <- res[which(res$padj < 0.05), ] # making dataframe of only significantly DE genes
res_sig <- as.data.frame(res_sig)
res_sig <- res_sig[order(res_sig$padj), ]
res_sig$gene_symbol <- counts_df$gene_name[match(rownames(res_sig), counts_df$gene_id)] # adding gene names to make it easier to interpret
kable(res_sig, format = "html", digits = 3, caption = "Significant DE Genes")
```

MC2 seems to cluster together, but MC1 is scattered without any clear clustering. 
```{r, echo = FALSE}
# principal component analysis (PCA)
vst_data <- vst(dds, blind = TRUE)
counts_matrix <- assay(vst_data)
var_genes <- order(apply(counts_matrix, 1, var), decreasing = TRUE)[1:500]
top_counts <- counts_matrix[var_genes, ]

pca_res <- prcomp(t(top_counts))

pca_data <- as.data.frame(pca_res$x)
pca_data$group <- colData(dds)[["group"]]

ggplot(pca_data, aes_string(x = paste0("PC", 1),
                            y = paste0("PC", 2),
                            color = "group")) +
  geom_point(size = 3) +
  xlab(paste("PC", 1)) +
  ylab(paste("PC", 2)) +
  theme_minimal() +
  scale_color_discrete(name = "group")
```
There are 171 total differentially expressed genes (padj < 0.05)

```{r, fig.height=10}
volcano_plot <- EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue')
volcano_plot
```

Below are the top 20 differentially expressed genes. 

```{r}
sig_genes <- rownames(res_sig)
top_20 <- order(sig_genes)[1:20]
heatmap_genes <- counts_matrix[top_20, ]

pheatmap(heatmap_genes,
         cluster_rows = TRUE,
         cluster_cols = FALSE,
         fontsize_row = 8,
         main = "Top 20 Variable Genes Heatmap")

```
528 pathways were found to be significantly differentially enriched (padj < 0.05) with the C2 curated gene sets from the Human MSigDB Collections, converted to mouse orthologs with the msigdbr package.
I've extracted a few particular that might be of interest:
- KEGG_NEUROACTIVE_LIGAND_RECEPTOR_INTERACTION
- WP_GPCRS_CLASS_A_RHODOPSINLIKE
In the GSEAres dataframe, the leading edge column shows what differentially expressed genes are most contributing to this ranking of pathways. 

```{r, echo=FALSE}
gene_sets_df <- msigdbr(species = 'mouse', category = 'C2')
gene_sets <- gene_sets_df %>%
  split(x = .$ensembl_gene, f = .$gs_name)
rankings <- sign(res$log2FoldChange)*(-log10(res$pvalue)) # we will use the signed p values as ranking (using padj, which are discrete variables, can lead to ties)
names(rankings) <- rownames(res)
rankings <- na.omit(rankings)

GSEAres <- fgsea(pathways = gene_sets, 
                 stats = rankings,
                 scoreType = 'std', 
                 minSize = 10,
                 maxSize = 500,
                 nproc = 1) 
head(GSEAres[order(pval), ])

```